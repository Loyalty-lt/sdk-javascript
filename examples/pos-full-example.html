<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System - Loyalty.lt SDK Example</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ably@1.2.48/build/ably.min.js"></script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts as fallback -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Satoshi', 'Inter', 'system-ui', 'sans-serif'],
                        'display': ['Clash Display', 'Satoshi', 'sans-serif'],
                        'heading': ['Clash Display', 'Satoshi', 'sans-serif'],
                    },
                    colors: {
                        'loyalty-primary': '#29594B',
                        'loyalty-heading': '#19352D',
                        'loyalty-text': '#4B5563',
                        'loyalty-accent': '#CFFF45',
                        'loyalty-accent-dark': '#E6FD5A',
                        'loyalty-light-bg': '#EDF1EE',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Satoshi Font Family */
        @font-face {
            font-family: 'Satoshi';
            font-style: normal;
            font-weight: 300;
            src: url('https://partners.loyalty.lt/public/assets/satoshi/fonts/Satoshi-Light.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Satoshi';
            font-style: normal;
            font-weight: 400;
            src: url('https://partners.loyalty.lt/public/assets/satoshi/fonts/Satoshi-Regular.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Satoshi';
            font-style: normal;
            font-weight: 500;
            src: url('https://partners.loyalty.lt/public/assets/satoshi/fonts/Satoshi-Medium.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Satoshi';
            font-style: normal;
            font-weight: 600;
            src: url('https://partners.loyalty.lt/public/assets/satoshi/fonts/Satoshi-Bold.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Satoshi';
            font-style: normal;
            font-weight: 700;
            src: url('https://partners.loyalty.lt/public/assets/satoshi/fonts/Satoshi-Bold.woff2') format('woff2');
        }

        /* Clash Display Font Family */
        @font-face {
            font-family: 'Clash Display';
            font-style: normal;
            font-weight: 400;
            src: url('https://partners.loyalty.lt/public/assets/clash-display/fonts/ClashDisplay-Regular.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Clash Display';
            font-style: normal;
            font-weight: 500;
            src: url('https://partners.loyalty.lt/public/assets/clash-display/fonts/ClashDisplay-Medium.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Clash Display';
            font-style: normal;
            font-weight: 600;
            src: url('https://partners.loyalty.lt/public/assets/clash-display/fonts/ClashDisplay-Semibold.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Clash Display';
            font-style: normal;
            font-weight: 700;
            src: url('https://partners.loyalty.lt/public/assets/clash-display/fonts/ClashDisplay-Bold.woff2') format('woff2');
        }
        
        body {
            font-family: 'Satoshi', 'Inter', system-ui, sans-serif;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Clash Display', 'Satoshi', sans-serif;
        }
        
        .loyalty-gradient {
            background: linear-gradient(135deg, #29594B 0%, #19352D 100%);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(41, 89, 75, 0.3);
            border-radius: 3px;
        }
    </style>
</head>
<body class="h-screen overflow-hidden">
    <!-- LOGIN MODAL -->
    <div id="loginScreen" class="fixed inset-0 z-50 bg-loyalty-light-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl border border-loyalty-primary/20 max-w-md w-full overflow-hidden">
            <div class="loyalty-gradient p-8 text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-white/20 flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white">POS System Login</h2>
                <p class="text-white/80 text-sm mt-2">Enter your Partner API credentials</p>
            </div>
            
            <div class="p-8 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-loyalty-text/70 mb-2">API Key</label>
                    <input 
                        type="text" 
                        id="apiKeyInput" 
                        placeholder="lty_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                        class="w-full px-4 py-3 border border-loyalty-primary/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-loyalty-primary/50 text-loyalty-heading"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-loyalty-text/70 mb-2">API Secret</label>
                    <input 
                        type="password" 
                        id="apiSecretInput" 
                        placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                        class="w-full px-4 py-3 border border-loyalty-primary/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-loyalty-primary/50 text-loyalty-heading"
                    >
                </div>
                <button 
                    onclick="connectPOS()" 
                    class="w-full loyalty-gradient text-white px-6 py-4 rounded-full font-semibold hover:shadow-lg transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]"
                >
                    <span id="connectBtnText">Connect</span>
                </button>
                <p id="loginError" class="hidden text-red-600 text-sm text-center"></p>
            </div>
        </div>
    </div>

    <!-- SUCCESS MODAL -->
    <div id="successModal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden">
            <div class="loyalty-gradient p-8 text-center">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-white/20 flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white">Payment Successful!</h2>
            </div>
            <div class="p-6 text-center">
                <p id="successMessage" class="text-loyalty-text/70 mb-2"></p>
                <p id="pointsEarned" class="text-xl font-bold text-loyalty-primary mb-6"></p>
                <button 
                    onclick="closeSuccessModal()" 
                    class="w-full loyalty-gradient text-white px-6 py-3 rounded-full font-semibold hover:shadow-lg transition-all"
                >
                    New Transaction
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN SPLIT LAYOUT -->
    <div class="grid grid-cols-2 h-screen">
        
        <!-- LEFT: CUSTOMER DISPLAY -->
        <div class="loyalty-gradient flex flex-col items-center justify-center text-center p-8 relative">
            <img src="https://cdn.loyalty.lt/loyalty-public/logo/logo_dark.png" alt="Loyalty.lt" class="h-10 absolute top-6 left-6">
            
            <!-- Scan View -->
            <div id="cdScanView" class="flex flex-col items-center">
                <h2 class="text-4xl font-bold text-white mb-8">Welcome!</h2>
                
                <div class="bg-white p-6 rounded-2xl shadow-2xl mb-8 relative">
                    <img id="cdQrImage" class="w-64 h-64" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='256' height='256'%3E%3Crect fill='%23EDF1EE' width='256' height='256'/%3E%3Ctext x='128' y='128' text-anchor='middle' fill='%2329594B' font-size='14'%3EConnecting...%3C/text%3E%3C/svg%3E" alt="QR Code">
                    <div id="qrScanOverlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm rounded-2xl flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-12 h-12 border-4 border-loyalty-primary border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                            <div class="text-loyalty-primary font-medium">Identifying...</div>
                        </div>
                    </div>
                </div>
                
                <h3 class="text-2xl text-white font-medium mb-2">Scan with Loyalty.lt app</h3>
                <p class="text-white/70">to earn points & access rewards</p>
                
                <div class="mt-6 px-6 py-3 rounded-full bg-white/10 text-white/90 flex items-center gap-3">
                    <div class="w-5 h-5 border-2 border-white/70 border-t-transparent rounded-full animate-spin"></div>
                    Waiting for scan...
                </div>
            </div>
            
            <!-- Customer View -->
            <div id="cdCustomerView" class="hidden flex flex-col items-center">
                <h2 class="text-3xl text-white/80 mb-6">Welcome back!</h2>
                
                <div class="bg-white/10 backdrop-blur rounded-2xl p-8 mb-6 min-w-[320px]">
                    <div id="cdCustomerName" class="text-3xl font-bold text-white mb-2">-</div>
                    <div id="cdCardNumber" class="text-white/50 text-sm font-mono mb-4">-</div>
                    <div class="text-white/60 text-sm mb-2">Your Points</div>
                    <div id="cdCustomerPoints" class="text-6xl font-bold text-loyalty-accent">0</div>
                </div>
                
                <div class="bg-white/5 rounded-xl p-6 min-w-[320px]">
                    <div class="text-white/60 text-sm mb-2">Current Total</div>
                    <div id="cdTotal" class="text-5xl font-bold text-white mb-2">‚Ç¨0.00</div>
                    <div id="cdPointsEarn" class="text-loyalty-accent text-lg">You'll earn +0 points</div>
                </div>
            </div>
        </div>
        
        <!-- RIGHT: POS SYSTEM -->
        <div class="bg-white flex flex-col h-screen">
            <!-- Header -->
            <div class="bg-loyalty-light-bg border-b border-loyalty-primary/10 px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://cdn.loyalty.lt/loyalty-public/logo/logo_light.png" alt="Loyalty.lt" class="h-8">
                    <span class="font-semibold text-loyalty-heading">POS System</span>
                </div>
                <div class="text-right">
                    <div id="shopName" class="font-semibold text-loyalty-heading">-</div>
                    <div id="shopAddress" class="text-sm text-loyalty-text/70">-</div>
                </div>
            </div>
            
            <!-- Status Bar -->
            <div class="bg-white border-b border-loyalty-primary/10 px-6 py-3 flex gap-3 flex-wrap">
                <span id="connectionStatus" class="px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">‚óè Disconnected</span>
                <span id="customerStatus" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">No customer</span>
                <span id="qrStatus" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">QR: Waiting</span>
            </div>
            
            <!-- Main Content -->
            <div class="flex-1 grid grid-cols-[1fr_280px] overflow-hidden">
                <!-- Products & Customer -->
                <div class="p-4 overflow-y-auto scrollbar-thin space-y-4">
                    <!-- Products -->
                    <div class="bg-loyalty-light-bg rounded-xl p-4">
                        <h3 class="text-xs uppercase tracking-wider text-loyalty-text/50 font-semibold mb-3">Products</h3>
                        <div id="productsGrid" class="grid grid-cols-5 gap-2"></div>
                    </div>
                    
                    <!-- Customer -->
                    <div class="bg-loyalty-light-bg rounded-xl p-4">
                        <h3 class="text-xs uppercase tracking-wider text-loyalty-text/50 font-semibold mb-3">Customer</h3>
                        
                        <div id="noCustomer" class="text-center py-6">
                            <div class="text-4xl mb-2">üë§</div>
                            <p class="text-loyalty-text/70 text-sm">No customer identified</p>
                            <p class="text-loyalty-text/50 text-xs mt-1">Waiting for QR scan...</p>
                        </div>
                        
                        <div id="customerCard" class="hidden loyalty-gradient rounded-xl p-4 text-white">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div id="customerName" class="text-lg font-semibold">-</div>
                                    <div id="customerPhone" class="text-white/70 text-sm">-</div>
                                </div>
                                <button onclick="clearCustomer()" class="text-white/70 hover:text-white text-xs px-2 py-1 bg-white/10 rounded-full">
                                    Clear
                                </button>
                            </div>
                            <div class="bg-white/10 rounded-lg px-3 py-2 mb-3">
                                <div class="text-white/60 text-xs">Card Number</div>
                                <div id="customerCardNumber" class="text-sm font-mono font-medium tracking-wider">-</div>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-white/60 text-xs">Points</div>
                                    <div id="customerPoints" class="text-2xl font-bold">0</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-white/60 text-xs">Value</div>
                                    <div id="pointsWorth" class="text-lg font-semibold">‚Ç¨0.00</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabs -->
                        <div class="mt-4 border-t border-loyalty-primary/10 pt-4">
                            <div class="flex gap-1 mb-3">
                                <button class="tab-btn flex-1 px-3 py-2 text-xs font-medium rounded-lg bg-loyalty-primary text-white" onclick="showCustomerTab('lookup')">Card Lookup</button>
                                <button class="tab-btn flex-1 px-3 py-2 text-xs font-medium rounded-lg bg-white text-loyalty-text border border-loyalty-primary/20" onclick="showCustomerTab('sendlink')">Send App Link</button>
                            </div>
                            
                            <div id="lookupTab">
                                <div class="flex gap-2">
                                    <input type="text" id="cardNumberInput" placeholder="Enter card number..." class="flex-1 px-3 py-2 text-sm border border-loyalty-primary/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-loyalty-primary/50">
                                    <button onclick="lookupCard()" class="px-4 py-2 text-sm bg-loyalty-primary text-white rounded-lg font-medium hover:bg-loyalty-heading transition-colors">Search</button>
                                </div>
                            </div>
                            
                            <div id="sendlinkTab" class="hidden">
                                <div class="flex gap-2">
                                    <input type="tel" id="phoneInput" placeholder="+370 6XX XXXXX" class="flex-1 px-3 py-2 text-sm border border-loyalty-primary/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-loyalty-primary/50">
                                    <button onclick="sendAppLink()" class="px-4 py-2 text-sm bg-loyalty-primary text-white rounded-lg font-medium hover:bg-loyalty-heading transition-colors">
                                        <span id="sendLinkBtnText">üì± Send</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cart Sidebar -->
                <div class="bg-loyalty-light-bg border-l border-loyalty-primary/10 p-4 flex flex-col">
                    <h3 class="text-xs uppercase tracking-wider text-loyalty-text/50 font-semibold mb-3">Cart</h3>
                    
                    <div id="cartItems" class="flex-1 overflow-y-auto scrollbar-thin">
                        <p class="text-loyalty-text/50 text-sm text-center py-8">Cart is empty</p>
                    </div>
                    
                    <div class="border-t border-loyalty-primary/10 pt-4 mt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-loyalty-text/70">Subtotal</span>
                            <span id="subtotal" class="font-medium">‚Ç¨0.00</span>
                        </div>
                        <div id="discountRow" class="hidden flex justify-between text-sm text-green-600">
                            <span>Discount</span>
                            <span id="discountAmount">-‚Ç¨0.00</span>
                        </div>
                        <div id="pointsDiscountRow" class="hidden flex justify-between text-sm text-green-600">
                            <span>Points (<span id="pointsUsedLabel">0</span>)</span>
                            <span id="pointsDiscountAmount">-‚Ç¨0.00</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold pt-2 border-t border-loyalty-primary/10">
                            <span>Total</span>
                            <span id="totalAmount">‚Ç¨0.00</span>
                        </div>
                        
                        <div id="pointsEarnPreview" class="hidden bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                            <div class="text-green-600 text-xs">Customer earns</div>
                            <div class="text-green-700 text-xl font-bold">+<span id="pointsToEarn">0</span> pts</div>
                        </div>
                        
                        <div id="redeemSection" class="hidden bg-white rounded-lg p-3 border border-loyalty-primary/10">
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-loyalty-text/70">Redeem points</span>
                                <span id="redeemValue" class="text-green-600 font-medium">0 = ‚Ç¨0.00</span>
                            </div>
                            <input type="range" id="redeemSlider" class="w-full" min="0" max="0" value="0" oninput="updateRedeemValue()">
                        </div>
                        
                        <button id="payBtn" onclick="processPayment()" disabled class="w-full loyalty-gradient text-white px-4 py-3 rounded-full font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg transition-all">
                            Process Payment
                        </button>
                        <button onclick="clearCart()" class="w-full border-2 border-loyalty-primary/30 text-loyalty-text px-4 py-2 rounded-full font-medium text-sm hover:bg-loyalty-light-bg transition-colors">
                            Clear Cart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../dist/index.umd.js"></script>
    <script>
        let sdk = null;
        let currentCustomer = null;
        let currentCard = null;
        let cart = [];
        let appliedOffer = null;
        let pointsToRedeem = 0;
        let qrSession = null;
        let ablyClient = null;
        let ablyChannel = null;
        let sessionChannel = null;
        let shoppingSessionId = null;
        let pointsRules = null;
        
        // Default values, will be overridden by pointsRules from backend
        const DEFAULT_POINTS_TO_EUR = 0.01;
        const DEFAULT_EUR_TO_POINTS = 10;
        
        const DEMO_PRODUCTS = [
            { id: 1, name: 'Espresso', price: 2.50, emoji: '‚òï' },
            { id: 2, name: 'Cappuccino', price: 3.50, emoji: '‚òï' },
            { id: 3, name: 'Latte', price: 4.00, emoji: 'ü•õ' },
            { id: 4, name: 'Croissant', price: 2.80, emoji: 'ü•ê' },
            { id: 5, name: 'Muffin', price: 3.20, emoji: 'üßÅ' },
            { id: 6, name: 'Sandwich', price: 5.50, emoji: 'ü•™' },
            { id: 7, name: 'Salad', price: 7.90, emoji: 'ü•ó' },
            { id: 8, name: 'Juice', price: 3.00, emoji: 'üßÉ' },
            { id: 9, name: 'Water', price: 1.50, emoji: 'üíß' },
            { id: 10, name: 'Cookie', price: 1.80, emoji: 'üç™' },
        ];
        
        function initProducts() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = DEMO_PRODUCTS.map(p => `
                <button onclick="addToCart(${p.id})" class="bg-white rounded-xl p-3 text-center hover:shadow-md hover:scale-105 transition-all border-2 border-transparent hover:border-loyalty-primary">
                    <div class="text-2xl mb-1">${p.emoji}</div>
                    <div class="text-xs text-loyalty-heading font-medium truncate">${p.name}</div>
                    <div class="text-xs text-loyalty-primary font-bold">‚Ç¨${p.price.toFixed(2)}</div>
                </button>
            `).join('');
        }
        
        async function connectPOS() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const apiSecret = document.getElementById('apiSecretInput').value.trim();
            const errorEl = document.getElementById('loginError');
            const btnText = document.getElementById('connectBtnText');
            
            if (!apiKey || !apiSecret) {
                errorEl.textContent = 'Please enter API Key and API Secret';
                errorEl.classList.remove('hidden');
                return;
            }
            
            btnText.innerHTML = '<span class="flex items-center justify-center gap-2"><span class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span> Connecting...</span>';
            errorEl.classList.add('hidden');
            
            try {
                const SDK = window.LoyaltySDK?.LoyaltySDK || window.LoyaltySDK?.default || window.LoyaltySDK;
                
                if (!SDK) throw new Error('SDK not loaded');
                
                sdk = new SDK({
                    apiKey: apiKey,
                    apiSecret: apiSecret,
                    environment: 'production',
                    locale: 'lt'
                });
                
                const validation = await sdk.validateCredentials();
                
                document.getElementById('shopName').textContent = validation.partner_name;
                document.getElementById('connectionStatus').className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700';
                document.getElementById('connectionStatus').textContent = '‚óè Connected';
                
                const shops = await sdk.getShops();
                if (shops.data && shops.data.length > 0) {
                    document.getElementById('shopAddress').textContent = shops.data[0].address || shops.data[0].phone || '';
                }
                
                document.getElementById('loginScreen').classList.add('hidden');
                initProducts();
                generateQR();
                
            } catch (error) {
                console.error('Connection error:', error);
                errorEl.textContent = error.message || 'Connection failed';
                errorEl.classList.remove('hidden');
                btnText.textContent = 'Connect';
            }
        }
        
        async function generateQR() {
            if (!sdk) return;
            
            try {
                // Hide scan overlay when generating new QR
                document.getElementById('qrScanOverlay').classList.add('hidden');
                document.getElementById('qrStatus').textContent = 'QR: Generating...';
                document.getElementById('qrStatus').className = 'px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700';
                
                qrSession = await sdk.generateQrCardSession('POS Terminal');
                
                const qrUrl = `https://api.loyalty.lt/qr?size=256&data=${encodeURIComponent(qrSession.qr_code)}`;
                document.getElementById('cdQrImage').src = qrUrl;
                
                document.getElementById('qrStatus').textContent = 'QR: Active';
                document.getElementById('qrStatus').className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700';
                
                await subscribeToQrEvents(qrSession.session_id);
                
            } catch (error) {
                console.error('QR generation error:', error);
                document.getElementById('qrStatus').textContent = 'QR: Error';
                document.getElementById('qrStatus').className = 'px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700';
                setTimeout(generateQR, 5000);
            }
        }
        
        async function subscribeToQrEvents(sessionId) {
            try {
                if (ablyChannel) ablyChannel.unsubscribe();
                if (ablyClient) ablyClient.close();
                
                const ablyOptions = await sdk.createAblyClientOptions(sessionId);
                ablyClient = new Ably.Realtime(ablyOptions);
                
                const tokenResponse = await sdk.getAblyToken(sessionId);
                ablyChannel = ablyClient.channels.get(tokenResponse.channel);
                
                ablyChannel.subscribe('card_identified', (message) => {
                    console.log('[POS] card_identified received:', message.data);
                    // Show blur overlay on QR
                    document.getElementById('qrScanOverlay').classList.remove('hidden');
                    // Backend sends { session_id, status, card_data: {...}, timestamp }
                    const cardData = message.data.card_data || message.data;
                    handleCardIdentified(cardData);
                });
                
            } catch (error) {
                console.error('Ably error:', error);
                startPolling(sessionId);
            }
        }
        
        function startPolling(sessionId) {
            const interval = setInterval(async () => {
                try {
                    const status = await sdk.pollQrCardStatus(sessionId);
                    if (status.status === 'completed' && status.card_data) {
                        clearInterval(interval);
                        // Show blur overlay on QR
                        document.getElementById('qrScanOverlay').classList.remove('hidden');
                        handleCardIdentified(status.card_data);
                    } else if (status.status === 'expired') {
                        clearInterval(interval);
                        generateQR();
                    }
                } catch (e) {}
            }, 2000);
            
            setTimeout(() => clearInterval(interval), 300000);
        }
        
        async function handleCardIdentified(cardData) {
            console.log('[POS] Processing card data:', cardData);
            
            // Backend sends: { loyalty_card_id, card_number, points, user: { id, name, phone }, redemption }
            currentCard = {
                id: cardData.loyalty_card_id || cardData.id,
                card_number: cardData.card_number,
                points: cardData.points || cardData.points_balance || 0
            };
            
            currentCustomer = {
                id: cardData.user?.id || cardData.user_id,
                name: cardData.user?.name || cardData.user?.phone || 'Customer',
                phone: cardData.user?.phone || '',
                points: cardData.points || cardData.points_balance || 0
            };
            
            // Store points rules if available (backend sends as 'redemption')
            pointsRules = cardData.redemption || cardData.points_rules || null;
            
            document.getElementById('noCustomer').classList.add('hidden');
            document.getElementById('customerCard').classList.remove('hidden');
            document.getElementById('customerName').textContent = currentCustomer.name;
            document.getElementById('customerPhone').textContent = currentCustomer.phone;
            document.getElementById('customerCardNumber').textContent = currentCard.card_number || '-';
            document.getElementById('customerPoints').textContent = currentCustomer.points.toLocaleString();
            document.getElementById('pointsWorth').textContent = '‚Ç¨' + calculatePointsValue(currentCustomer.points).toFixed(2);
            
            document.getElementById('customerStatus').textContent = '‚úì ' + currentCustomer.name;
            document.getElementById('customerStatus').className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700';
            
            // Slider max will be set in updateCart based on subtotal
            document.getElementById('redeemSlider').max = currentCustomer.points;
            document.getElementById('redeemSlider').value = 0;
            
            document.getElementById('cdScanView').classList.add('hidden');
            document.getElementById('cdCustomerView').classList.remove('hidden');
            document.getElementById('cdCustomerName').textContent = currentCustomer.name;
            document.getElementById('cdCardNumber').textContent = currentCard.card_number || '';
            document.getElementById('cdCustomerPoints').textContent = currentCustomer.points.toLocaleString();
            
            // Start shopping session
            await startShoppingSession(cardData);
            
            updateCart();
        }
        
        async function startShoppingSession(cardData) {
            if (!currentCustomer?.id || !qrSession) return;
            
            try {
                // Generate unique session ID
                shoppingSessionId = `session_${Date.now()}_${currentCard.id}`;
                console.log('[POS] Starting shopping session:', shoppingSessionId);
                
                // Get Ably client options with automatic token renewal
                const ablyOptions = await sdk.createAblyClientOptions(qrSession.session_id, {
                    user_id: currentCustomer.id,
                    shopping_session_id: shoppingSessionId
                });
                
                // Reconnect Ably with new token
                if (ablyClient) ablyClient.close();
                ablyClient = new Ably.Realtime(ablyOptions);
                
                // Subscribe to session channel for customer updates
                sessionChannel = ablyClient.channels.get(`session-${shoppingSessionId}`);
                sessionChannel.subscribe('session_update', (message) => {
                    handleSessionUpdate(message.data);
                });
                
                // Get shop info
                const shopName = document.getElementById('shopName').textContent;
                const shopAddress = document.getElementById('shopAddress').textContent;
                
                // Publish session_created to user's channel
                const userChannel = ablyClient.channels.get(`user-${currentCustomer.id}`);
                const sessionData = {
                    sessionId: shoppingSessionId,
                    cardId: currentCard.id,
                    shopId: qrSession.shop_id || 1,
                    staffId: 1,
                    customerId: currentCustomer.id,
                    status: 'editing',
                    customerInfo: {
                        name: currentCustomer.name,
                        availablePoints: currentCustomer.points,
                        cardNumber: currentCard.card_number || ''
                    },
                    staffInfo: {
                        id: 1,
                        name: 'POS Terminal'
                    },
                    shopInfo: {
                        id: qrSession.shop_id || '1',
                        name: shopName,
                        address: shopAddress,
                        logo: null
                    },
                    pointsRules: pointsRules || {
                        points_per_currency: DEFAULT_EUR_TO_POINTS,
                        currency_amount: 1,
                        points_redemption_enabled: true,
                        points_per_currency_redemption: 100,
                        currency_amount_redemption: 1,
                        min_points_for_redemption: 100,
                        max_points_per_redemption: 10000
                    },
                    purchaseAmount: '',
                    pointsToRedeem: '',
                    customerPointsInput: '',
                    description: '',
                    calculatedPoints: 0,
                    paymentMethod: null,
                    lastUpdatedBy: 'staff',
                    timestamp: new Date().toISOString()
                };
                
                await userChannel.publish('session_created', sessionData);
                console.log('[POS] session_created sent to user-' + currentCustomer.id);
                
            } catch (error) {
                console.error('[POS] Error starting shopping session:', error);
            }
        }
        
        function handleSessionUpdate(data) {
            console.log('[POS] Received session_update:', data);
            
            // Customer updated points to redeem
            if (data.lastUpdatedBy === 'customer' && data.customerPointsInput !== undefined) {
                let customerPoints = parseInt(data.customerPointsInput) || 0;
                
                // Validate: can't redeem more points than purchase amount allows
                const subtotal = calculateSubtotal();
                const maxPointsForAmount = calculateMaxPointsForAmount(subtotal);
                const maxRedeemable = Math.min(currentCustomer?.points || 0, maxPointsForAmount);
                
                if (customerPoints > maxRedeemable) {
                    customerPoints = maxRedeemable;
                    console.log('[POS] Customer points capped to max redeemable:', maxRedeemable);
                }
                
                document.getElementById('redeemSlider').value = customerPoints;
                pointsToRedeem = customerPoints;
                document.getElementById('redeemValue').textContent = `${pointsToRedeem} = ‚Ç¨${calculatePointsValue(pointsToRedeem).toFixed(2)}`;
                updateCart();
                console.log('[POS] Customer set points to redeem:', customerPoints);
            }
            
            // Customer selected payment method / requested payment
            if (data.paymentMethod || data.status === 'processing') {
                console.log('[POS] Customer requested payment:', data.paymentMethod);
                showPaymentRequest(data);
            }
        }
        
        function showPaymentRequest(data) {
            const paymentMethod = data.paymentMethod || 'unknown';
            const methodText = paymentMethod === 'app_payment' ? 'App Payment' : 
                               paymentMethod === 'cash' ? 'Cash Payment' : paymentMethod;
            
            // Play notification sound (optional)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleVEgQqDNwJsV');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch (e) {}
            
            // Show notification on POS
            const notification = document.createElement('div');
            notification.id = 'paymentNotification';
            notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-8 py-5 rounded-2xl shadow-2xl z-50';
            notification.innerHTML = `
                <div class="flex flex-col items-center gap-3">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center animate-pulse">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                        </div>
                        <div>
                            <div class="font-bold text-xl">Customer Requests Payment!</div>
                            <div class="text-sm opacity-90">Method: ${methodText} ‚Ä¢ Total: ‚Ç¨${calculateTotal().toFixed(2)}</div>
                        </div>
                    </div>
                    <button onclick="processPaymentFromNotification()" class="mt-2 bg-white text-green-600 px-6 py-2 rounded-full font-bold hover:bg-green-50 transition-all">
                        Complete Payment Now
                    </button>
                </div>
            `;
            
            // Remove existing notification if any
            const existing = document.getElementById('paymentNotification');
            if (existing) existing.remove();
            
            document.body.appendChild(notification);
            
            // Update customer display to show payment pending
            updateCustomerDisplayPayment(methodText);
            
            // Enable pay button and change its text
            const payBtn = document.getElementById('payBtn');
            if (payBtn && cart.length > 0) {
                payBtn.disabled = false;
                payBtn.innerHTML = '<span class="animate-pulse">Complete Payment</span>';
                payBtn.classList.add('ring-2', 'ring-green-400', 'ring-offset-2');
            }
        }
        
        function processPaymentFromNotification() {
            // Remove notification
            const notification = document.getElementById('paymentNotification');
            if (notification) notification.remove();
            
            // Process the payment
            processPayment();
        }
        
        function updateCustomerDisplayPayment(methodText) {
            const customerDisplayContent = document.getElementById('customerDisplayContent');
            if (!customerDisplayContent) return;
            
            customerDisplayContent.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse">
                        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-loyalty-text mb-2">Payment Requested</h3>
                    <p class="text-loyalty-text/70 mb-4">Method: ${methodText}</p>
                    <div class="bg-loyalty-primary/10 rounded-xl p-4 max-w-xs mx-auto">
                        <p class="text-loyalty-text font-medium">Total: ‚Ç¨${calculateTotal().toFixed(2)}</p>
                        ${pointsToRedeem > 0 ? `<p class="text-sm text-loyalty-text/70">Points discount: ‚Ç¨${calculatePointsDiscount().toFixed(2)}</p>` : ''}
                    </div>
                    <p class="text-sm text-loyalty-text/50 mt-4">Waiting for staff to complete payment...</p>
                </div>
            `;
        }
        
        function updateCustomerDisplaySuccess(total, pointsEarned, pointsDiscount) {
            const customerDisplayContent = document.getElementById('customerDisplayContent');
            if (!customerDisplayContent) return;
            
            customerDisplayContent.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-14 h-14 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <h3 class="text-3xl font-bold text-green-600 mb-2">Payment Complete!</h3>
                    <p class="text-loyalty-text/70 mb-6">Thank you for your purchase</p>
                    <div class="bg-loyalty-primary/10 rounded-xl p-6 max-w-xs mx-auto">
                        <p class="text-2xl font-bold text-loyalty-text mb-2">‚Ç¨${total.toFixed(2)}</p>
                        ${pointsDiscount > 0 ? `<p class="text-sm text-loyalty-text/70 mb-2">Points discount: -‚Ç¨${pointsDiscount.toFixed(2)}</p>` : ''}
                        ${pointsEarned > 0 ? `<p class="text-loyalty-primary font-bold text-lg">+${pointsEarned} points earned!</p>` : ''}
                    </div>
                </div>
            `;
        }
        
        async function sendSessionUpdate() {
            if (!sessionChannel || !shoppingSessionId) return;
            
            const subtotal = calculateSubtotal();
            const pointsDiscount = calculatePointsDiscount();
            const total = calculateTotal();
            const pointsToEarn = calculatePointsToEarn();
            
            const updateData = {
                sessionId: shoppingSessionId,
                purchaseAmount: total.toFixed(2),
                subtotal: subtotal.toFixed(2),
                pointsToEarn: pointsToEarn,
                pointsToRedeem: pointsToRedeem.toString(),
                pointsDiscountAmount: pointsDiscount.toFixed(2),
                calculatedPoints: pointsToEarn,
                status: total > 0 ? 'editing' : 'editing',
                lastUpdatedBy: 'staff',
                timestamp: new Date().toISOString()
            };
            
            try {
                await sessionChannel.publish('session_update', updateData);
                console.log('[POS] session_update sent:', updateData);
            } catch (error) {
                console.error('[POS] Error sending session_update:', error);
            }
        }
        
        function showCustomerTab(tab) {
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.className = 'tab-btn flex-1 px-3 py-2 text-xs font-medium rounded-lg ' + 
                    ((i === 0 && tab === 'lookup') || (i === 1 && tab === 'sendlink') 
                        ? 'bg-loyalty-primary text-white' 
                        : 'bg-white text-loyalty-text border border-loyalty-primary/20');
            });
            document.getElementById('lookupTab').classList.toggle('hidden', tab !== 'lookup');
            document.getElementById('sendlinkTab').classList.toggle('hidden', tab !== 'sendlink');
        }
        
        async function lookupCard() {
            const cardNumber = document.getElementById('cardNumberInput').value.trim();
            if (!cardNumber) return alert('Enter card number');
            
            try {
                const cards = await sdk.getLoyaltyCards({ card_number: cardNumber });
                if (cards.data && cards.data.length > 0) {
                    handleCardIdentified(cards.data[0]);
                } else {
                    alert('Card not found');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function sendAppLink() {
            const phone = document.getElementById('phoneInput').value.trim();
            if (!phone) return alert('Enter phone number');
            
            const btn = document.getElementById('sendLinkBtnText');
            btn.innerHTML = '<span class="flex items-center gap-1"><span class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></span></span>';
            
            try {
                const shopId = qrSession?.shop_id || 1;
                await sdk.sendAppLink(phone, shopId);
                btn.textContent = '‚úì Sent!';
                setTimeout(() => { btn.textContent = 'üì± Send'; }, 3000);
            } catch (error) {
                alert('Error: ' + error.message);
                btn.textContent = 'üì± Send';
            }
        }
        
        function addToCart(productId) {
            const product = DEMO_PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            const existing = cart.find(item => item.id === productId);
            if (existing) existing.qty++;
            else cart.push({ ...product, qty: 1 });
            
            updateCart();
        }
        
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }
        
        function calculateSubtotal() { return cart.reduce((sum, item) => sum + (item.price * item.qty), 0); }
        function calculateDiscount() { return appliedOffer ? (appliedOffer.percent ? calculateSubtotal() * appliedOffer.percent / 100 : appliedOffer.amount || 0) : 0; }
        
        // Calculate currency value of points using pointsRules
        function calculatePointsValue(points) {
            if (!points || points <= 0) return 0;
            if (!pointsRules) return points * DEFAULT_POINTS_TO_EUR;
            const pointsPerCurrency = pointsRules.points_per_currency_redemption || pointsRules.points_per_currency || (1 / DEFAULT_POINTS_TO_EUR);
            const currencyAmount = pointsRules.currency_amount_redemption || pointsRules.currency_amount || 1;
            return Math.round((points / pointsPerCurrency) * currencyAmount * 100) / 100;
        }
        
        // Calculate discount amount from points to redeem
        function calculatePointsDiscount() {
            return calculatePointsValue(pointsToRedeem);
        }
        
        function calculateTotal() { return Math.max(0, calculateSubtotal() - calculateDiscount() - calculatePointsDiscount()); }
        
        // Calculate points to earn using pointsRules
        function calculatePointsToEarn() {
            const total = calculateTotal();
            if (!pointsRules || total <= 0) return Math.floor(total * DEFAULT_EUR_TO_POINTS);
            const pointsPerCurrency = pointsRules.points_per_currency || DEFAULT_EUR_TO_POINTS;
            const currencyAmount = pointsRules.currency_amount || 1;
            return Math.floor((total / currencyAmount) * pointsPerCurrency);
        }
        
        // Calculate max points that can be redeemed for given amount
        function calculateMaxPointsForAmount(amount) {
            if (!amount || amount <= 0) return 0;
            if (!pointsRules) return Math.ceil(amount / DEFAULT_POINTS_TO_EUR);
            const pointsPerCurrency = pointsRules.points_per_currency_redemption || pointsRules.points_per_currency || (1 / DEFAULT_POINTS_TO_EUR);
            const currencyAmount = pointsRules.currency_amount_redemption || pointsRules.currency_amount || 1;
            return Math.ceil((amount / currencyAmount) * pointsPerCurrency);
        }
        
        function updateRedeemValue() {
            pointsToRedeem = parseInt(document.getElementById('redeemSlider').value);
            document.getElementById('redeemValue').textContent = `${pointsToRedeem} = ‚Ç¨${calculatePointsValue(pointsToRedeem).toFixed(2)}`;
            updateCart();
        }
        
        function updateCart() {
            const cartEl = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                cartEl.innerHTML = '<p class="text-loyalty-text/50 text-sm text-center py-8">Cart is empty</p>';
            } else {
                cartEl.innerHTML = cart.map(item => `
                    <div class="flex justify-between items-center py-2 border-b border-loyalty-primary/10">
                        <div class="flex-1">
                            <div class="text-sm font-medium text-loyalty-heading">${item.emoji} ${item.name}</div>
                            <div class="text-xs text-loyalty-text/50">${item.qty} x ‚Ç¨${item.price.toFixed(2)}</div>
                        </div>
                        <div class="text-sm font-semibold text-loyalty-heading">‚Ç¨${(item.price * item.qty).toFixed(2)}</div>
                        <button onclick="removeFromCart(${item.id})" class="ml-2 text-red-500 hover:text-red-700 text-xs px-2">‚úï</button>
                    </div>
                `).join('');
            }
            
            const subtotal = calculateSubtotal();
            const discount = calculateDiscount();
            const pointsDiscount = calculatePointsDiscount();
            const total = calculateTotal();
            const pointsToEarn = calculatePointsToEarn();
            
            document.getElementById('subtotal').textContent = '‚Ç¨' + subtotal.toFixed(2);
            document.getElementById('totalAmount').textContent = '‚Ç¨' + total.toFixed(2);
            
            document.getElementById('discountRow').classList.toggle('hidden', discount <= 0);
            document.getElementById('discountAmount').textContent = '-‚Ç¨' + discount.toFixed(2);
            
            document.getElementById('pointsDiscountRow').classList.toggle('hidden', pointsDiscount <= 0);
            document.getElementById('pointsUsedLabel').textContent = pointsToRedeem;
            document.getElementById('pointsDiscountAmount').textContent = '-‚Ç¨' + pointsDiscount.toFixed(2);
            
            const showCustomerFeatures = currentCustomer && cart.length > 0;
            document.getElementById('pointsEarnPreview').classList.toggle('hidden', !showCustomerFeatures);
            document.getElementById('redeemSection').classList.toggle('hidden', !showCustomerFeatures);
            document.getElementById('pointsToEarn').textContent = pointsToEarn;
            
            // Update slider max based on subtotal - can't redeem more than purchase amount
            if (currentCustomer) {
                const maxPointsForAmount = calculateMaxPointsForAmount(subtotal);
                const maxRedeemable = Math.min(currentCustomer.points, maxPointsForAmount);
                const slider = document.getElementById('redeemSlider');
                slider.max = maxRedeemable;
                // If current value exceeds new max, reset it
                if (pointsToRedeem > maxRedeemable) {
                    pointsToRedeem = maxRedeemable;
                    slider.value = maxRedeemable;
                    document.getElementById('redeemValue').textContent = `${pointsToRedeem} = ‚Ç¨${calculatePointsValue(pointsToRedeem).toFixed(2)}`;
                }
            }
            
            document.getElementById('payBtn').disabled = cart.length === 0;
            
            document.getElementById('cdTotal').textContent = '‚Ç¨' + total.toFixed(2);
            document.getElementById('cdPointsEarn').textContent = currentCustomer ? `You'll earn +${pointsToEarn} points` : '';
            
            // Send session update to customer's app
            if (currentCustomer && shoppingSessionId) {
                sendSessionUpdate();
            }
        }
        
        async function processPayment() {
            const btn = document.getElementById('payBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="flex items-center justify-center gap-2"><span class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span> Processing...</span>';
            
            try {
                const subtotal = calculateSubtotal();
                const total = calculateTotal();
                const pointsEarned = calculatePointsToEarn();
                const pointsDiscount = calculatePointsDiscount();
                
                // Create real transaction if customer is identified
                if (currentCustomer && currentCard) {
                    try {
                        const orderId = `POS-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        const cartItems = cart.map(item => ({
                            product_name: item.name,
                            quantity: item.qty,
                            unit_price: item.price,
                            total_price: item.price * item.qty
                        }));
                        
                        const transactionResult = await sdk.createTransaction({
                            user_id: currentCustomer.id,
                            order_id: orderId,
                            order_total: subtotal,
                            currency: 'EUR',
                            loyalty_card_id: currentCard.id,
                            points_redeemed: pointsToRedeem,
                            points_discount_amount: pointsDiscount,
                            description: `POS Purchase - ${cart.map(i => i.name).join(', ')}`,
                            cart_items: cartItems
                        });
                        console.log('[POS] Transaction created:', transactionResult);
                        
                        // Send transaction_completed and session_ended to customer's app
                        if (ablyClient && currentCustomer?.id) {
                            const userChannel = ablyClient.channels.get(`user-${currentCustomer.id}`);
                            
                            // Send transaction_completed
                            await userChannel.publish('transaction_completed', {
                                transaction_id: transactionResult.id,
                                card_id: currentCard.id,
                                amount: subtotal,
                                currency: 'EUR',
                                points_awarded: pointsEarned,
                                points_redeemed: pointsToRedeem,
                                points_discount_amount: pointsDiscount,
                                final_amount: total,
                                timestamp: new Date().toISOString()
                            });
                            console.log('[POS] transaction_completed sent');
                            
                            // Send session_update with completed status
                            if (sessionChannel) {
                                await sessionChannel.publish('session_update', {
                                    sessionId: shoppingSessionId,
                                    status: 'completed',
                                    lastUpdatedBy: 'staff',
                                    timestamp: new Date().toISOString()
                                });
                            }
                            
                            // Send session_ended to close everything in the app
                            await userChannel.publish('session_ended', {
                                sessionId: shoppingSessionId,
                                reason: 'payment_completed',
                                transaction_id: transactionResult.id,
                                points_awarded: pointsEarned,
                                points_redeemed: pointsToRedeem,
                                final_amount: total,
                                timestamp: new Date().toISOString()
                            });
                            console.log('[POS] session_ended sent');
                        }
                    } catch (txError) {
                        console.error('[POS] Transaction error:', txError);
                    }
                }
                
                await new Promise(r => setTimeout(r, 500));
                
                document.getElementById('successMessage').textContent = 
                    `Amount: ‚Ç¨${total.toFixed(2)} ${currentCustomer ? '‚Ä¢ ' + currentCustomer.name : ''}`;
                document.getElementById('pointsEarned').textContent = 
                    currentCustomer && pointsEarned > 0 ? `+${pointsEarned} points earned!` : '';
                
                // Update customer display to show success
                updateCustomerDisplaySuccess(total, pointsEarned, pointsDiscount);
                
                document.getElementById('successModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('[POS] Payment error:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Process Payment';
                btn.classList.remove('ring-2', 'ring-green-400', 'ring-offset-2');
                
                // Remove payment notification if still visible
                const notification = document.getElementById('paymentNotification');
                if (notification) notification.remove();
            }
        }
        
        async function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            clearCart();
            await clearCustomer();
        }
        
        function clearCart() {
            cart = [];
            appliedOffer = null;
            pointsToRedeem = 0;
            document.getElementById('redeemSlider').value = 0;
            updateCart();
        }
        
        async function clearCustomer() {
            // Send session_ended to customer's app
            if (ablyClient && currentCustomer?.id && shoppingSessionId) {
                try {
                    const userChannel = ablyClient.channels.get(`user-${currentCustomer.id}`);
                    await userChannel.publish('session_ended', {
                        sessionId: shoppingSessionId,
                        reason: 'cleared',
                        timestamp: new Date().toISOString()
                    });
                    console.log('[POS] session_ended sent');
                } catch (error) {
                    console.error('[POS] Error sending session_ended:', error);
                }
            }
            
            currentCustomer = null;
            currentCard = null;
            shoppingSessionId = null;
            sessionChannel = null;
            pointsRules = null;
            
            // Remove payment notification if visible
            const notification = document.getElementById('paymentNotification');
            if (notification) notification.remove();
            
            // Reset pay button styling
            const payBtn = document.getElementById('payBtn');
            if (payBtn) {
                payBtn.classList.remove('ring-2', 'ring-green-400', 'ring-offset-2');
                payBtn.textContent = 'Process Payment';
            }
            
            document.getElementById('noCustomer').classList.remove('hidden');
            document.getElementById('customerCard').classList.add('hidden');
            
            document.getElementById('customerStatus').textContent = 'No customer';
            document.getElementById('customerStatus').className = 'px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600';
            
            document.getElementById('redeemSlider').max = 0;
            document.getElementById('redeemSlider').value = 0;
            
            document.getElementById('cdScanView').classList.remove('hidden');
            document.getElementById('cdCustomerView').classList.add('hidden');
            
            updateCart();
            generateQR();
        }
        
        // Cleanup on page unload - close all Ably sessions
        function cleanupSessionSync(reason = 'page_closed') {
            if (ablyClient && currentCustomer?.id && shoppingSessionId) {
                try {
                    const userChannel = ablyClient.channels.get(`user-${currentCustomer.id}`);
                    // Fire and forget - don't await, just publish
                    userChannel.publish('session_ended', {
                        sessionId: shoppingSessionId,
                        reason: reason,
                        timestamp: new Date().toISOString()
                    });
                    console.log('[POS] session_ended queued:', reason);
                } catch (error) {
                    console.error('[POS] Error queueing session_ended:', error);
                }
            }
            
            if (ablyClient) {
                try {
                    // Close connection - Ably will try to flush pending messages
                    ablyClient.close();
                    console.log('[POS] Ably connection closing');
                } catch (error) {
                    console.error('[POS] Error closing Ably:', error);
                }
            }
        }
        
        window.addEventListener('beforeunload', (event) => {
            cleanupSessionSync('page_closed');
        });
        
        window.addEventListener('pagehide', (event) => {
            // More reliable on mobile browsers
            if (!event.persisted) {
                cleanupSessionSync('page_hide');
            }
        });
        
        initProducts();
    </script>
</body>
</html>
